<div id='mvc-alert' class="modal fade" role="dialog" style='z-index: 1100'>
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header" mvc-show='opts.title'>
        <h5 class="modal-title">
          <span mvc-text='opts.title'></span>
        </h5>
      </div>

      <div class="modal-body">
        <div class="container-fluid">
          <div class='row form-group'>
            <div class='col-12 text-center'>
              <span mvc-html='opts.text'>
              </span>
            </div>
          </div>

          <div class='row form-group' mvc-show='isPrompt'>
            <div class='col-12'>
              <input type='text' mvc-value='opts.value' class='form-control'>
            </div>
          </div>
        </div>

        <div class='row form-group'>
          <div class='col-12' mvc-each='opts.buttons' id='mvc-alert-button-container'>
            <button class='btn btn-sm m-1' mvc-class='opts.buttons.$index.class' data-index='$index' mvc-on='{click: "clicked"}'>
              <span mvc-text='opts.buttons.$index.text'></span>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal" tabindex="-1" role="dialog" id='mvc-spinner'>
  <div class="modal-dialog modal-dialog-centered justify-content-center" role="document">
    <div class="d-flex justify-content-center">
      <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var contextClasses, contextWidgets;
  
  if ('QnD' in window) {
    contextClasses = window.QnD.classes;
    contextWidgets = window.QnD.widgets;
  } 
  else {
    contextClasses = window;
    contextWidgets = window;
  }
  
  (function() {
    class Modal extends contextClasses.MVC {
      constructor() {
        super('mvc-alert');
        
        var self = this;

        //this.modal = $('#' + this.element);
        this.modal = document.getElementById(this._element);
    
        this.spinner = {
          show: function() {
            self._modalOpen(document.getElementById('mvc-spinner'));
            //$('#mvc-spinner').modal({backdrop: 'static', keyboard: false, show: true});
          },
      
          hide: function() {
            self._modalClose(document.getElementById('mvc-spinner'));
            //$('#mvc-spinner').modal('hide');
          },  
        }
        
        this.createModel();
      }

      createModel() {
        this.model.opts = {
          type: '',
          title: '',
          text: '',
          value: '',
          buttons: [],
          defaultButton: 0,
          okayButton: 0,
        };

        this.model.isPrompt = false;
        
        this.resolve = '';
        this.reject = '';
      }

      open() {
        this._modalOpen(this.modal);
        
        this.opened();
      }

      opened() {
        var self = this;

        setTimeout(function() {
          document.getElementById('mvc-alert-button-container').querySelector('button[data-index="' + self.model.opts.defaultButton + '"]').focus();
        },500)
      }

      close() {
        this._modalClose(this.modal);
      }

      common(type, resolve, reject, opts) {
        var self = this;
        opts.type = type;

        opts.buttons.forEach(function(btn, idx) {
          btn.value = btn.value || idx;
        })

        if (!('defaultButton') in opts || !opts.defaultButton) opts.defaultButton = '0';
        if (!('okayButton') in opts || !opts.okayButton) opts.okayButton = '0';

        this.resolve = resolve;
        this.reject = reject;
        this.model.opts = opts;

        this.open();
      }

      alert(options) {
        var self = this;
        this.model.isPrompt = false;

        return new Promise(function(resolve, reject) {
          options = options || '';

          if (QnD.utils.object.isObject(options) === false) {
            options = {text: options, buttons: [{text: 'Okay', class: 'btn-primary'}], defaultButton: 0, okayButton: 0};
          }

          self.common('alert', resolve, reject, options)
        })
      }

      prompt(options, value) {
        var self = this;
        this.model.isPrompt = true;

        return new Promise(function(resolve, reject) {
          options = options || '';

          if (QnD.utils.object.isObject(options) === false) {
            options = {text: options, value: value || '', buttons: [{text: 'Okay', class: 'btn-primary'}, {text: 'Cancel', class: 'btn-danger'}], defaultButton: 0, okayButton: 0};
          }

          self.common('prompt', resolve, reject, options)
        })
      }

      confirm(options) {
        var self = this;
        this.model.isPrompt = false;

        return new Promise(function(resolve, reject) {
          options = options || '';

          if (QnD.utils.object.isObject(options) === false) {
            options = {text: options, buttons: [{text: 'Okay', class: 'btn-primary'}, {text: 'Cancel', class: 'btn-danger'}], defaultButton: 1, okayButton: 0};
          }

          self.common('confirm', resolve, reject, options)
        })
      }
      
      clicked(ev) {
        var btnIdx = ev.target.closest('button').getAttribute('data-index');
        var btn = this.model.opts.buttons[btnIdx];

        if (this.model.opts.type == 'prompt') {
          if (btnIdx == this.model.opts.okayButton) {
            this.resolve(this.model.opts.value);
          }
          else {
            this.reject(btn.value);
          }
        }
        else {
          this.resolve(btn.value);
        }

        this.close();
      }
      
      _modalOpen(el) {
        el.className="modal fade show";
        el.style.display = 'block';
        el.style['padding-right'] = '17px';
        
        document.body.className = 'modal-open';
        document.body.style['padding-right'] = '17px';
        
        this.backdropDiv = document.createElement('div');
        this.backdropDiv.className='modal-backdrop fade show';
        document.body.appendChild(this.backdropDiv); 
      }
      
      _modalClose(el) {
        el.className="modal fade";
        el.style.display = 'none';
        el.style['padding-right'] = '0px';
        
        document.body.style['padding-right'] = '0px'
        document.body.className = '';   
        this.backdropDiv.remove();     
      }
    }

    contextClasses.Modal = Modal;
    contextWidgets.modal = new contextClasses.Modal();

  // let ret = await QnD.widgets.modal.confirm('blah');
})();
</script>