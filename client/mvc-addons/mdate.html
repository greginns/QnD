<style>
.mvc-boot-cal-table {
  table-layout: fixed;
}

.mvc-boot-cal-offmonth {
  color: #ccc;
}

</style>

<div id='mvc-boot-cal' class="modal fade" role="dialog" style='z-index: 2100'>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <span mvc-text='dateInWords'></span>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" mvc-on='{click: "calClose"}'>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">

        <span mvc-show='cal.cal1'>
          <table class='table table-bordered table-sm mvc-boot-cal-table'>
            <thead>
              <tr>
                <th>
                  <button class='btn btn-primary' mvc-on='{click: "cal1PrevYear"}'>
                    &lt;
                  </button>
                </th>
                <th colspan='5' style='text-align: center'>
                  <button class='btn btn-primary' mvc-on='{click: "cal1Month"}'>
                    <span mvc-text='cal1.month'></span>
                  </button>
                  <button class='btn btn-primary' mvc-on='{click: "cal1Year"}'>
                    <span mvc-text='cal1.year'></span>
                  </button>
                </th>
                <th style='text-align: right'>
                  <button class='btn btn-primary' mvc-on='{click: "cal1NextYear"}'>
                    &gt;
                  </button>
                </th>
              </tr>

              <tr>
                <th width='14.28%'>Su</th>
                <th width='14.28%'>Mo</th>
                <th width='14.28%'>Tu</th>
                <th width='14.32%'>We</th>
                <th width='14.28%'>Th</th>
                <th width='14.28%'>Fr</th>
                <th width='14.28%'>Sa</th>
              </tr>
            </thead>

            <tbody mvc-on='{click: "cal1DayClicked"}' style='cursor: pointer'>
              <tr>
                <td mvc-attr='{"data-year": "cal1.attrs.0.year", "data-month": "cal1.attrs.0.month", "data-day": "cal1.attrs.0.day"}'><span mvc-text='cal1.days.0' mvc-class='cal1.classes.0'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.1.year", "data-month": "cal1.attrs.1.month", "data-day": "cal1.attrs.1.day"}'><span mvc-text='cal1.days.1' mvc-class='cal1.classes.1'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.2.year", "data-month": "cal1.attrs.2.month", "data-day": "cal1.attrs.2.day"}'><span mvc-text='cal1.days.2' mvc-class='cal1.classes.2'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.3.year", "data-month": "cal1.attrs.3.month", "data-day": "cal1.attrs.3.day"}'><span mvc-text='cal1.days.3' mvc-class='cal1.classes.3'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.4.year", "data-month": "cal1.attrs.4.month", "data-day": "cal1.attrs.4.day"}'><span mvc-text='cal1.days.4' mvc-class='cal1.classes.4'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.5.year", "data-month": "cal1.attrs.5.month", "data-day": "cal1.attrs.5.day"}'><span mvc-text='cal1.days.5' mvc-class='cal1.classes.5'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.6.year", "data-month": "cal1.attrs.6.month", "data-day": "cal1.attrs.6.day"}'><span mvc-text='cal1.days.6' mvc-class='cal1.classes.6'></span></td>
              </tr>
              <tr>
                <td mvc-attr='{"data-year": "cal1.attrs.7.year", "data-month": "cal1.attrs.7.month", "data-day": "cal1.attrs.7.day"}'><span mvc-text='cal1.days.7' mvc-class='cal1.classes.7'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.8.year", "data-month": "cal1.attrs.8.month", "data-day": "cal1.attrs.8.day"}'><span mvc-text='cal1.days.8' mvc-class='cal1.classes.8'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.9.year", "data-month": "cal1.attrs.9.month", "data-day": "cal1.attrs.9.day"}'><span mvc-text='cal1.days.9' mvc-class='cal1.classes.9'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.10.year", "data-month": "cal1.attrs.10.month", "data-day": "cal1.attrs.10.day"}'><span mvc-text='cal1.days.10' mvc-class='cal1.classes.10'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.11.year", "data-month": "cal1.attrs.11.month", "data-day": "cal1.attrs.11.day"}'><span mvc-text='cal1.days.11' mvc-class='cal1.classes.11'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.12.year", "data-month": "cal1.attrs.12.month", "data-day": "cal1.attrs.12.day"}'><span mvc-text='cal1.days.12' mvc-class='cal1.classes.12'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.13.year", "data-month": "cal1.attrs.13.month", "data-day": "cal1.attrs.13.day"}'><span mvc-text='cal1.days.13' mvc-class='cal1.classes.13'></span></td>
              </tr>
              <tr>
                <td mvc-attr='{"data-year": "cal1.attrs.14.year", "data-month": "cal1.attrs.14.month", "data-day": "cal1.attrs.14.day"}'><span mvc-text='cal1.days.14' mvc-class='cal1.classes.14'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.15.year", "data-month": "cal1.attrs.15.month", "data-day": "cal1.attrs.15.day"}'><span mvc-text='cal1.days.15' mvc-class='cal1.classes.15'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.16.year", "data-month": "cal1.attrs.16.month", "data-day": "cal1.attrs.16.day"}'><span mvc-text='cal1.days.16' mvc-class='cal1.classes.16'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.17.year", "data-month": "cal1.attrs.17.month", "data-day": "cal1.attrs.17.day"}'><span mvc-text='cal1.days.17' mvc-class='cal1.classes.17'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.18.year", "data-month": "cal1.attrs.18.month", "data-day": "cal1.attrs.18.day"}'><span mvc-text='cal1.days.18' mvc-class='cal1.classes.18'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.19.year", "data-month": "cal1.attrs.19.month", "data-day": "cal1.attrs.19.day"}'><span mvc-text='cal1.days.19' mvc-class='cal1.classes.19'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.20.year", "data-month": "cal1.attrs.20.month", "data-day": "cal1.attrs.20.day"}'><span mvc-text='cal1.days.20' mvc-class='cal1.classes.20'></span></td>
              </tr>
              <tr>
                <td mvc-attr='{"data-year": "cal1.attrs.21.year", "data-month": "cal1.attrs.21.month", "data-day": "cal1.attrs.21.day"}'><span mvc-text='cal1.days.21' mvc-class='cal1.classes.21'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.22.year", "data-month": "cal1.attrs.22.month", "data-day": "cal1.attrs.22.day"}'><span mvc-text='cal1.days.22' mvc-class='cal1.classes.22'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.23.year", "data-month": "cal1.attrs.23.month", "data-day": "cal1.attrs.23.day"}'><span mvc-text='cal1.days.23' mvc-class='cal1.classes.23'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.24.year", "data-month": "cal1.attrs.24.month", "data-day": "cal1.attrs.24.day"}'><span mvc-text='cal1.days.24' mvc-class='cal1.classes.24'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.25.year", "data-month": "cal1.attrs.25.month", "data-day": "cal1.attrs.25.day"}'><span mvc-text='cal1.days.25' mvc-class='cal1.classes.25'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.26.year", "data-month": "cal1.attrs.26.month", "data-day": "cal1.attrs.26.day"}'><span mvc-text='cal1.days.26' mvc-class='cal1.classes.26'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.27.year", "data-month": "cal1.attrs.27.month", "data-day": "cal1.attrs.27.day"}'><span mvc-text='cal1.days.27' mvc-class='cal1.classes.27'></span></td>
              </tr>
              <tr>
                <td mvc-attr='{"data-year": "cal1.attrs.28.year", "data-month": "cal1.attrs.28.month", "data-day": "cal1.attrs.28.day"}''><span mvc-text='cal1.days.28' mvc-class='cal1.classes.28'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.29.year", "data-month": "cal1.attrs.29.month", "data-day": "cal1.attrs.29.day"}''><span mvc-text='cal1.days.29' mvc-class='cal1.classes.29'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.30.year", "data-month": "cal1.attrs.30.month", "data-day": "cal1.attrs.30.day"}''><span mvc-text='cal1.days.30' mvc-class='cal1.classes.30'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.31.year", "data-month": "cal1.attrs.31.month", "data-day": "cal1.attrs.31.day"}''><span mvc-text='cal1.days.31' mvc-class='cal1.classes.31'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.32.year", "data-month": "cal1.attrs.32.month", "data-day": "cal1.attrs.32.day"}''><span mvc-text='cal1.days.32' mvc-class='cal1.classes.32'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.33.year", "data-month": "cal1.attrs.33.month", "data-day": "cal1.attrs.33.day"}''><span mvc-text='cal1.days.33' mvc-class='cal1.classes.33'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.34.year", "data-month": "cal1.attrs.34.month", "data-day": "cal1.attrs.34.day"}''><span mvc-text='cal1.days.34' mvc-class='cal1.classes.34'></span></td>
              </tr>
              <tr>
                <td mvc-attr='{"data-year": "cal1.attrs.35.year", "data-month": "cal1.attrs.35.month", "data-day": "cal1.attrs.35.day"}''><span mvc-text='cal1.days.35' mvc-class='cal1.classes.35'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.36.year", "data-month": "cal1.attrs.36.month", "data-day": "cal1.attrs.36.day"}''><span mvc-text='cal1.days.36' mvc-class='cal1.classes.36'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.37.year", "data-month": "cal1.attrs.37.month", "data-day": "cal1.attrs.37.day"}''><span mvc-text='cal1.days.37' mvc-class='cal1.classes.37'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.38.year", "data-month": "cal1.attrs.38.month", "data-day": "cal1.attrs.38.day"}''><span mvc-text='cal1.days.38' mvc-class='cal1.classes.38'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.39.year", "data-month": "cal1.attrs.39.month", "data-day": "cal1.attrs.39.day"}''><span mvc-text='cal1.days.39' mvc-class='cal1.classes.39'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.40.year", "data-month": "cal1.attrs.40.month", "data-day": "cal1.attrs.40.day"}''><span mvc-text='cal1.days.40' mvc-class='cal1.classes.40'></span></td>
                <td mvc-attr='{"data-year": "cal1.attrs.41.year", "data-month": "cal1.attrs.41.month", "data-day": "cal1.attrs.41.day"}''><span mvc-text='cal1.days.41' mvc-class='cal1.classes.41'></span></td>
              </tr>
            </tbody>
          </table>
        </span>

        <span mvc-show='cal.cal2'>
          <table class='table table-bordered table-sm mvc-boot-cal-table'>
            <thead>
              <tr>
                <th>
                  <button class='btn btn-primary' mvc-on='{click: "cal2PrevYear"}'>
                    &lt;
                  </button>
                </th>
                <th style='text-align: center'>
                  <button class='btn btn-primary' mvc-on='{click: "cal2Year"}'>
                    <span mvc-text='cal2.year'></span>
                  </button>
                </th>
                <th style='text-align: right'>
                  <button class='btn btn-primary' mvc-on='{click: "cal2NextYear"}'>
                    &gt;
                  </button>
                </th>
              </tr>
            </thead>

            <tbody mvc-on='{click: "cal2MonthClicked"}' style='cursor: pointer'>
              <tr>
                <td data-month='0'>January</td>
                <td data-month='1'>February</td>
                <td data-month='2'>March</td>
              </tr>
              <tr>
                <td data-month='3'>April</td>
                <td data-month='4'>May</td>
                <td data-month='5'>June</td>
              </tr>
              <tr>
                <td data-month='6'>July</td>
                <td data-month='7'>August</td>
                <td data-month='8'>September</td>
              </tr>
              <tr>
                <td data-month='9'>October</td>
                <td data-month='10'>November</td>
                <td data-month='11'>December</td>
              </tr>
              <tr>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
              </tr>
              <tr>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
              </tr>
            </tbody>
          </table>
        </span>

        <span mvc-show='cal.cal3'>
          <table class='table table-bordered table-sm mvc-boot-cal-table'>
            <thead>
              <tr>
                <th>
                  <button class='btn btn-primary' mvc-on='{click: "cal3PrevDecade"}'>
                    &lt;
                  </button>
                </th>
                <th colspan='2' style='text-align: center'>
                </th>
                <th style='text-align: right'>
                  <button class='btn btn-primary' mvc-on='{click: "cal3NextDecade"}'>
                    &gt;
                  </button>
                </th>
              </tr>
            </thead>

            <tbody mvc-on='{click: "cal3YearClicked"}' style='cursor: pointer'>
              <tr>
                <td><span mvc-text='cal3.years.0'></span></td>
                <td><span mvc-text='cal3.years.1'></span></td>
                <td><span mvc-text='cal3.years.2'></span></td>
                <td><span mvc-text='cal3.years.3'></span></td>
              </tr>
              <tr>
                <td><span mvc-text='cal3.years.4'></span></td>
                <td><span mvc-text='cal3.years.5'></span></td>
                <td><span mvc-text='cal3.years.6'></span></td>
                <td><span mvc-text='cal3.years.7'></span></td>
              </tr>
              <tr>
                <td><span mvc-text='cal3.years.8'></span></td>
                <td><span mvc-text='cal3.years.9'></span></td>
                <td><span mvc-text='cal3.years.10'></span></td>
                <td><span mvc-text='cal3.years.11'></span></td>
              </tr>
              <tr>
                <td><span mvc-text='cal3.years.12'></span></td>
                <td><span mvc-text='cal3.years.13'></span></td>
                <td><span mvc-text='cal3.years.14'></span></td>
                <td><span mvc-text='cal3.years.15'></span></td>
              </tr>
              <tr>
                <td><span mvc-text='cal3.years.16'></span></td>
                <td><span mvc-text='cal3.years.17'></span></td>
                <td><span mvc-text='cal3.years.18'></span></td>
                <td><span mvc-text='cal3.years.19'></span></td>
              </tr>
              <tr>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
                <td>&nbsp;</td>
              </tr>
            </tbody>
          </table>
        </span>

      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  var contextClasses, contextWidgets;

  if ('QnD' in window) {
    contextClasses = window.QnD.classes;
    contextWidgets = window.QnD.widgets;
  } 
  else {
    contextClasses = window;
    contextWidgets = window;
  }
    
  (function() {
    class MDate extends contextClasses.MVC {
      constructor() {
        super('mvc-boot-cal');

        //this.modal = $('#' + this.element);
        this.modal = document.getElementById(this._element);

        this.createModel();
      }

      createModel() {
        this.model.cal = {
          cal1: false,
          cal2: false,
          cal3: false,
          origDt: '',
          currDt: '',
        };

        this.model.cal1 = {
          year: '',
          month: '',
          days: [],
          classes: [],
          attrs: [],
        };

        this.model.cal2 = {
          year: ''
        };

        this.model.cal3 = {
          src: 1,
          first: 0,
          last: 0,
          years: [],
        };

        this.model.dateInWords = '';
        this.model.modalShow = false;
        
        this.resolve = '';
      }

      calendar(dt) {
        // dt must be a moment object
        var self = this;

        if (!moment(dt).isValid()) dt = moment();
        
        this._modalOpen();
        
        this.model.cal.origDt = moment(dt);
        this.model.cal.currDt = moment(dt);

        this.cal1Init();
        
        return new Promise(function(resolve) {
          this.resolve = resolve;
        }.bind(this));
      }

      calOpenPane(cal) {
        this.model.cal.cal1 = false;
        this.model.cal.cal2 = false;
        this.model.cal.cal3 = false;

        this.model.cal['cal' + cal] = true;
      }

      calClose() {
        this.calHide();
        this.resolve(this.model.cal.origDt);
      }

      calDone() {
        this.calHide();
        this.resolve(this.model.cal.currDt);
      }

      calHide() {
        this._modalClose();
      }

      /* CAL 1 */
      cal1Init() {
        this.calOpenPane(1);
        this.cal1Display();
      }

      cal1Display() {
        var dt = this.model.cal.currDt;
        var origDt = this.model.cal.origDt;
        var fom = moment(dt).date(1);    // create first of the month
        var fomDow = fom.day();          // day of the week on the first
        var lom = moment(fom).add(1,'months').subtract(1,'days').date();    // last day of the month
        var plom = moment(fom).subtract(1,'days').date();  // last day of the month of prev month
        var month = dt.format('MMMM');
        var year = dt.format('YYYY');
        var mth = dt.month();
        var yr = dt.year();

        this.model.dateInWords = dt.format('dddd, MMMM Do, YYYY');

        var pdt = moment(dt).subtract(1, 'months');
        var pmth = pdt.month();
        var pyr = pdt.year();

        var ndt = moment(dt).add(1, 'months');
        var nmth = ndt.month();
        var nyr = ndt.year();

        // build list of 42 days
        var days = [], classes = [], attrs = [];

        for (var i=plom-fomDow+1; i<=plom; i++) {
          var klass=['mvc-boot-cal-offmonth'];

          days.push(i);
          attrs.push({'year': pyr, 'month': pmth, 'day': i});

          if (moment([pyr, pmth, i]).isSame(origDt, 'day')) {
            klass.push('text-danger');
          }

          classes.push(klass.join(' '));
        }

        for (var i=0,klass=[]; i<lom; i++) {
          var klass=[];

          days.push(i+1);
          attrs.push({'year': yr, 'month': mth, 'day': i+1});

          if (moment([yr, mth, i+1]).isSame(origDt, 'day')) {
            klass.push('text-danger');
          }

          classes.push(klass.join(' '));
        }

        var dl = 42-days.length;

        for (var i=0; i<dl; i++) {
          var klass=['mvc-boot-cal-offmonth'];

          days.push(i+1);
          attrs.push({'year': nyr, 'month': nmth, 'day': i+1});

          if (moment([nyr, nmth, i+1]).isSame(origDt, 'day')) {
            klass.push('text-danger');
          }

          classes.push(klass.join(' '));
        }

        this.model.cal1.days = days;
        this.model.cal1.classes = classes;
        this.model.cal1.attrs = attrs;
        this.model.cal1.year = year;
        this.model.cal1.month = month;
      }

      cal1PrevYear(ev) {
        this.model.cal.currDt = (this.model.cal.currDt).subtract(1, 'months');
        this.cal1Display();
      }

      cal1NextYear(ev) {
        this.model.cal.currDt = (this.model.cal.currDt).add(1, 'months');
        this.cal1Display();
      }

      cal1Year(ev) {
        this.cal3Init(1);
      }

      cal1Month(ev) {
        this.cal2Init();
      }

      cal1DayClicked(ev) {
        var td = ev.target.closest('td');
        var year = td.getAttribute('data-year');
        var month = td.getAttribute('data-month');
        var day = td.getAttribute('data-day');

        this.model.cal.currDt = moment([year, month, day]);
        this.calDone();
      }

      /* CAL 2 */
      cal2Init() {
        this.calOpenPane(2);
        this.cal2Display();
      }

      cal2Display() {
        var dt = this.model.cal.currDt;

        this.model.cal2.year = dt.format('YYYY');
      }

      cal2PrevYear(ev) {
        this.model.cal.currDt = (this.model.cal.currDt).subtract(1, 'years');

        this.cal2Display();
      }

      cal2NextYear(ev) {
        this.model.cal.currDt = (this.model.cal.currDt).add(1, 'years');

        this.cal2Display();
      }

      cal2Year(ev) {
        this.cal3Init(2);
      }

      cal2MonthClicked(ev) {
        var month = parseInt(ev.target.closest('td').getAttribute('data-month'), 10);

        this.model.cal.currDt = (this.model.cal.currDt).month(month);
        this.cal1Init();
      }

      /* CAL 3 */
      cal3Init(src) {
        var dt = this.model.cal.currDt;
        var year = '' + dt.year();
        var y = parseInt(year.substr(year.length-1, 1), 10) - 1;
        var first = dt.subtract(y, 'years').year();
        var last = first + 19;

        this.model.cal3.first = first;
        this.model.cal3.last = last;
        this.model.cal3.src = src;

        this.cal3Display();
        this.calOpenPane(3);
      }

      cal3Display() {
        var first = this.model.cal3.first;
        var last = this.model.cal3.last;
        var years = [];

        for (var i=first; i<=last; i++) {
          years.push(i);
        }

        this.model.cal3.years = years;
      }

      cal3PrevDecade(ev) {
        var first = this.model.cal3.first - 20;
        var last = first + 19;

        this.model.cal3.first = first;
        this.model.cal3.last = last;

        this.cal3Display();
      }

      cal3NextDecade(ev) {
        var first = this.model.cal3.first + 20;
        var last = first + 19;

        this.model.cal3.first = first;
        this.model.cal3.last = last;

        this.cal3Display();
      }

      cal3YearClicked(ev) {
        var year = parseInt(ev.target.closest('td').firstChild.innerText, 10);
        this.model.cal.currDt = (this.model.cal.currDt).year(year);

        if (parseInt(this.model.cal3.src, 10) == 1) {
          this.cal1Init();
        }
        else {
          this.cal2Init();
        }
      }
      
      _modalOpen() {
        this.modal.className="modal fade show";
        this.modal.style.display = 'block';
        this.modal.style['padding-right'] = '17px';
        
        document.body.className = 'modal-open';
        document.body.style['padding-right'] = '17px';
        
        this.backdropDiv = document.createElement('div');
        this.backdropDiv.className='modal-backdrop fade show';
        document.body.appendChild(this.backdropDiv); 
      }
      
      _modalClose() {
        this.modal.className="modal fade";
        this.modal.style.display = 'none';
        this.modal.style['padding-right'] = '0px';
        
        document.body.style['padding-right'] = '0px'
        document.body.className = '';   
        this.backdropDiv.remove();     
      }      
    }
    
    contextClasses.MDate = MDate;
    contextWidgets.mdate = new contextClasses.MDate();
    
/*  
    // await QnD.widgets.mdate.calendar(momentDate);
*/    
  })();
  
</script>