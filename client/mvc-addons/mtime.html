<style>
.mvc-boot-time-table {
  table-layout: fixed;
}
</style>

<div id='mvc-boot-time' class="modal fade" role="dialog" style='z-index: 1100'>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <span mvc-text='timeInWords'></span>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" mvc-on='{click: "timeClose"}'>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <table class='table table-bordered table-sm mvc-boot-time-table'>
          <tbody mvc-on='{click: "hourClicked"}' style='cursor: pointer'>
            <tr>
              <td data-hour='12AM' mvc-class='hourClasses.0'>12</td>
              <td data-hour='01AM' mvc-class='hourClasses.1'>1</td>
              <td data-hour='02AM' mvc-class='hourClasses.2'>2</td>
              <td data-hour='03AM' mvc-class='hourClasses.3'>3</td>
              <td data-hour='04AM' mvc-class='hourClasses.4'>4</td>
              <td data-hour='05AM' mvc-class='hourClasses.5'>5</td>
              <td data-hour='06AM' mvc-class='hourClasses.6'>6</td>
              <td data-hour='07AM' mvc-class='hourClasses.7'>7</td>
              <td data-hour='08AM' mvc-class='hourClasses.8'>8</td>
              <td data-hour='09AM' mvc-class='hourClasses.9'>9</td>
              <td data-hour='10AM' mvc-class='hourClasses.10'>10</td>
              <td data-hour='11AM' mvc-class='hourClasses.11'>11</td>
              <th>AM</th>
            </tr>
            <tr>
              <td data-hour='12PM' mvc-class='hourClasses.12'>12</td>
              <td data-hour='01PM' mvc-class='hourClasses.13'>1</td>
              <td data-hour='02PM' mvc-class='hourClasses.14'>2</td>
              <td data-hour='03PM' mvc-class='hourClasses.15'>3</td>
              <td data-hour='04PM' mvc-class='hourClasses.16'>4</td>
              <td data-hour='05PM' mvc-class='hourClasses.17'>5</td>
              <td data-hour='06PM' mvc-class='hourClasses.18'>6</td>
              <td data-hour='07PM' mvc-class='hourClasses.19'>7</td>
              <td data-hour='08PM' mvc-class='hourClasses.20'>8</td>
              <td data-hour='09PM' mvc-class='hourClasses.21'>9</td>
              <td data-hour='10PM' mvc-class='hourClasses.22'>10</td>
              <td data-hour='11PM' mvc-class='hourClasses.23'>11</td>
              <th>PM</th>
            </tr>
          </tbody>
        </table>

        <table class='table table-bordered table-sm mvc-boot-cal-table'>
          <tbody mvc-on='{click: "minuteClicked"}' style='cursor: pointer'>
            <tr>
              <th data-minute='00' mvc-class='minuteClasses.0'>:00</th>
              <td data-minute='01' mvc-class='minuteClasses.1'>:01</td>
              <td data-minute='02' mvc-class='minuteClasses.2'>:02</td>
              <td data-minute='03' mvc-class='minuteClasses.3'>:03</td>
              <td data-minute='04' mvc-class='minuteClasses.4'>:04</td>
              <th data-minute='05' mvc-class='minuteClasses.5'>:05</th>
              <td data-minute='06' mvc-class='minuteClasses.6'>:06</td>
              <td data-minute='07' mvc-class='minuteClasses.7'>:07</td>
              <td data-minute='08' mvc-class='minuteClasses.8'>:08</td>
              <td data-minute='09' mvc-class='minuteClasses.9'>:09</td>
            </tr>
            <tr>
              <th data-minute='10' mvc-class='minuteClasses.10'>:10</th>
              <td data-minute='11' mvc-class='minuteClasses.11'>:11</td>
              <td data-minute='12' mvc-class='minuteClasses.12'>:12</td>
              <td data-minute='13' mvc-class='minuteClasses.13'>:13</td>
              <td data-minute='14' mvc-class='minuteClasses.14'>:14</td>
              <th data-minute='15' mvc-class='minuteClasses.15'>:15</th>
              <td data-minute='16' mvc-class='minuteClasses.16'>:16</td>
              <td data-minute='17' mvc-class='minuteClasses.17'>:17</td>
              <td data-minute='18' mvc-class='minuteClasses.18'>:18</td>
              <td data-minute='19' mvc-class='minuteClasses.19'>:19</td>
            </tr>
            <tr>
              <th data-minute='20' mvc-class='minuteClasses.20'>:20</th>
              <td data-minute='21' mvc-class='minuteClasses.21'>:21</td>
              <td data-minute='22' mvc-class='minuteClasses.22'>:22</td>
              <td data-minute='23' mvc-class='minuteClasses.23'>:23</td>
              <td data-minute='24' mvc-class='minuteClasses.24'>:24</td>
              <th data-minute='25' mvc-class='minuteClasses.25'>:25</th>
              <td data-minute='26' mvc-class='minuteClasses.26'>:26</td>
              <td data-minute='27' mvc-class='minuteClasses.27'>:27</td>
              <td data-minute='28' mvc-class='minuteClasses.28'>:28</td>
              <td data-minute='29' mvc-class='minuteClasses.29'>:29</td>
            </tr>
            <tr>
              <th data-minute='30' mvc-class='minuteClasses.30'>:30</th>
              <td data-minute='31' mvc-class='minuteClasses.31'>:31</td>
              <td data-minute='32' mvc-class='minuteClasses.32'>:32</td>
              <td data-minute='33' mvc-class='minuteClasses.33'>:33</td>
              <td data-minute='34' mvc-class='minuteClasses.34'>:34</td>
              <th data-minute='35' mvc-class='minuteClasses.35'>:35</th>
              <td data-minute='36' mvc-class='minuteClasses.36'>:36</td>
              <td data-minute='37' mvc-class='minuteClasses.37'>:37</td>
              <td data-minute='38' mvc-class='minuteClasses.38'>:38</td>
              <td data-minute='39' mvc-class='minuteClasses.39'>:39</td>
            </tr>
            <tr>
              <th data-minute='40' mvc-class='minuteClasses.40'>:40</th>
              <td data-minute='41' mvc-class='minuteClasses.41'>:41</td>
              <td data-minute='42' mvc-class='minuteClasses.42'>:42</td>
              <td data-minute='43' mvc-class='minuteClasses.43'>:43</td>
              <td data-minute='44' mvc-class='minuteClasses.44'>:44</td>
              <th data-minute='45' mvc-class='minuteClasses.45'>:45</th>
              <td data-minute='46' mvc-class='minuteClasses.46'>:46</td>
              <td data-minute='47' mvc-class='minuteClasses.47'>:47</td>
              <td data-minute='48' mvc-class='minuteClasses.48'>:48</td>
              <td data-minute='49' mvc-class='minuteClasses.49'>:49</td>
            </tr>
            <tr>
              <th data-minute='50' mvc-class='minuteClasses.50'>:50</th>
              <td data-minute='51' mvc-class='minuteClasses.51'>:51</td>
              <td data-minute='52' mvc-class='minuteClasses.52'>:52</td>
              <td data-minute='53' mvc-class='minuteClasses.53'>:53</td>
              <td data-minute='54' mvc-class='minuteClasses.54'>:54</td>
              <th data-minute='55' mvc-class='minuteClasses.55'>:55</th>
              <td data-minute='56' mvc-class='minuteClasses.56'>:56</td>
              <td data-minute='57' mvc-class='minuteClasses.57'>:57</td>
              <td data-minute='58' mvc-class='minuteClasses.58'>:58</td>
              <td data-minute='59' mvc-class='minuteClasses.59'>:59</td>
            </tr>
          </tbody>
        </table>

        <div class='row form-group'>
          <div class='col-sm-12'>
            <button class='btn btn-primary' mvc-on='{click: "accept"}'>
              Accept
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  (function() {
    var contextClasses, contextWidgets;

    if ('QnD' in window) {
      contextClasses = window.QnD.classes;
      contextWidgets = window.QnD.widgets;
    } 
    else {
      contextClasses = window;
      contextWidgets = window;
    }
    
    class MTime extends contextClasses.MVC {
      constructor() {
        super('mvc-boot-time');

        this.modal = document.getElementById(this._element);

        this.createModel();
      }

      createModel() {
        this.model.timeInWords = '';
        this.model.orig = '';
        this.model.hour = ''
        this.model.minute = '';
        this.model.ampm = '';
        this.model.time = '';

        this.model.hourClasses = [];
        this.model.minuteClasses = [];
        
        this.resolve = '';
      }

      time(tm) {
        // tm must be Date.toJSON
        var hour, minute, ampm;
        
        if (!moment(tm).isValid()) tm = moment();

        this.model.orig = moment(tm);

        this._modalOpen();

        [hour, minute, ampm] = this.momentToAMPM(this.model.orig);

        this.model.hour = hour;
        this.model.minute = minute;
        this.model.ampm = ampm;

        this.makeTime();
        
        return new Promise(function(resolve) {
          this.resolve = resolve;
        }.bind(this));
      }

      hourClicked(ev) {
        var hr = ev.target.closest('td,th').getAttribute('data-hour');
        
        if (!hr) return;
        
        this.model.ampm = hr.substr(2);
        this.model.hour = hr.substr(0,2);

        this.makeTime();
      }

      minuteClicked(ev) {
        this.model.minute = ev.target.closest('td,th').getAttribute('data-minute');

        this.makeTime();
      }

      accept() {
        var hour = this.model.hour;
        var minute = this.model.minute;
        var ampm = this.model.ampm;
        var tm, cb;

        if (!hour) {
          this.timeClosed();
          return;
        }

        if (!minute) minute = '00';

        tm = hour + ':' + minute + ' ' + ampm;
        tm = moment(tm, 'hh:mm A');

        this.timeHide();
        this.resolve(tm);
      }

      makeTime() {
        var hour = this.model.hour;
        var minute = this.model.minute;
        var ampm = this.model.ampm;
        var ohour, ominute, oampm;

        for (var i=0; i<24; i++) {
          this.model.hourClasses[i] = '';
        }

        for (var i=0; i<60; i++) {
          this.model.minuteClasses[i] = '';
        }

        if (hour) this.model.timeInWords = hour + ':' + minute + ' ' + ampm;

        // highlight original time
        var orig = this.model.orig;

        if (orig) {
          [ohour, ominute, oampm] = this.momentToAMPM(orig);

          if (ohour == 12) ohour = 0;
          if (oampm == 'PM') ohour += 12;

          this.model.hourClasses[ohour] = 'text-danger';
          this.model.minuteClasses[ominute] = 'text-danger';
        }

        // highlight selected time
        if (hour) {
          var ohour = parseInt(hour, 10);
          var ominute = parseInt(minute, 10);

          if (ohour == 12) ohour = 0;
          if (ampm == 'PM') ohour += 12;

          this.model.hourClasses[ohour] = 'bg-warning';
          this.model.minuteClasses[ominute] = 'bg-warning';
        }
      }

      timeClose() {
        var cb = this.model.callback;
        var orig = this.model.orig;

        if (cb) cb(orig);

        this.timeHide();
      }

      timeHide() {
        this._modalClose();
      }

      momentToAMPM(tm) {
        var hour = tm.hour();
        var minute = tm.minute();
        var ampm = 'AM';

        if (hour > 11) {
          hour = hour-12;
          ampm = 'PM';
        }

        if (minute.length == 1) minute = '0' + minute;

        return [hour, minute, ampm];
      }
      
      _modalOpen() {
        this.modal.className="modal fade show";
        this.modal.style.display = 'block';
        this.modal.style['padding-right'] = '17px';
        
        document.body.className = 'modal-open';
        document.body.style['padding-right'] = '17px';
        
        this.backdropDiv = document.createElement('div');
        this.backdropDiv.className='modal-backdrop fade show';
        document.body.appendChild(this.backdropDiv); 
      }
      
      _modalClose() {
        this.modal.className="modal fade";
        this.modal.style.display = 'none';
        this.modal.style['padding-right'] = '0px';
        
        document.body.style['padding-right'] = '0px'
        document.body.className = '';   
        this.backdropDiv.remove();     
      }
    }
    
    contextClasses.MTime = MTime;
    contextWidgets.mtime = new contextClasses.MTime();
/*
  // await QnD.widgets.mtime.time(momentDate);
*/
  })();
</script>
